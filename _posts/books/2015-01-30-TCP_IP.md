---
layout： POST
category: book
title: 《图解TCP/IP》
---

##Summary
看的不算特别仔细，本来也就是入门的，简单记录一下吧。

----

##基础知识

|OSI|功能|
|------|------|
|应用层|为应用程序提供服务，并规定应用程序中通信相关细节。包括文件传输、电子邮件和远程登录等协议|
|表示层|将应用程序的信息转化为适合网路传输的格式，或将下一层的数据转化为上一层能够处理的格式。具体来说就是将设备固有的数据格式转化为网络标准传输格式。（首部增加格式编码信息）|
|会话层|负责建立和断开通信连接（数据流动的逻辑通路），以及数据的分割等数据传输相关的管理。（首部增加数据传递顺序的信息）|
|传输层|起着可靠传输的作用，只在通信双方节点上进行，而无需在路由器上处理。（如果数据没有到达，它会负责重发。）|
|网络层|主要负责寻址和路由选择。（能够将数据从A发送到B都是网络层的功劳。）|
|数据链路层|负责物理层面上互连的、节点之间的通信传输。（首部增加MAC地址）|
|物理层|负责0，1比特流与电压的高低、光的|

|设备|功能|
|----|----|
|网卡|使计算机联网的设备|
|中继器（Repeater）|从物理层上延长网络的设备|
|网桥（Bridge）/ 2层交换机|从数据链路层上延长网络的设备|
|路由器（Router）/ 3层交换机|通过网络层转发分组数据的设备|
|4 -7 层交换机|处理传输层以上各层网络传输的设备|
|网关（Gateway）|转换协议的设备|

![image](http://francisnote.qiniudn.com/tcp_ip_5.png)

----

##IP协议
IP相当于OSI参考模型中的第三层----网络层。网络层的主要作用是“实现终端节点之间的通信”。

网络层的下一层----数据链路层的主要作用是在互连同一种数据链路的节点之间进行包传递，而一旦跨越多种数据链路，就需要借助网络层。网络层可以跨越不同的数据链路，即使是在不同的数据链路上也能实现两端节点之间的数据包传递。

假设一个人要去很远的地方旅行，并且计划先后乘坐飞机，火车，汽车到达目的地，那么：

 - 数据链路层相当于飞机票、火车票和汽车票，每张票只能在某一限定区间内移动，换乘时需要重新买票。
 - 网络层相当于行程表，说明从哪里到哪里这样。
 
 如果我们只有行程没有车票，那么无法到达目的地；反之只有车票没有目的地，恐怕也很难到达目的地。（网络层的功能在于寻址和路由，而数据链路层负责物理层面数据的传送。）
 ![image](http://francisnote.qiniudn.com/tcp_ip_1.png)
 
路由控制是指将分组数据发送到最终目标地址的功能。

路由控制表，为了将数据包发送给目标主机，所有主机都维护着一张路由控制表。该表记录IP数据在下一步应该发送给那个路由器。IP包在网络中每个区间被转发（一个区间也叫“跳”），每次转发只会决定将该IP包下次转发到哪里，并不会确定到达目标主机的完整路径。
 
 IP属于面向无连接型，即在发包之前不需要建立与目标地址之间的连接。
 
  - 面向有连接的情况下，需要事先建立连接，如果目标主机不存在或关机，就不可能建立连接，也就不可能发送数据。
  - 面向无连接的情况下，即使目标主机不存在或关机，数据依旧能发送出去。反之对于一台主机，它不知道何时会从哪里收到数据。通常应该进行网络监控，让主机只接收发给自己的包，如果没有准备好，很有可能会错过一些数据包。因此，面向无连接的情况下很可能会有很多冗余的通信。
  
  IP采用无连接的方式只要是为了简化和提速。管理连接本身就是一个相当繁琐的事情，此外每次通信之前都需要先建立连接也会减低处理速度。（需要连接的时候，可以委托上一层提供此服务。为提高可靠性，上一层的TCP采用面向有连接型。）
  
  通常一块网卡只设置一个IP地址，其实一块网卡可以设置多个IP地址。此外一台路由器通常会配置两个以上的网卡。
  
  IP地址由网络标示和主机标示两部分组成，网络标示表明其属于那个网络，不同的数据链路段拥有不同的网络标示，同一个网络标示里，IP地址的主机标示不同。主机标示的位数，表明该网段最多可以有多少台主机。
  
  IP地址分为四个级别A,B,C,D，不同在于网络标示的位数，依次是8，16，24，32（二进制）。另外要用比特位表示主机地址时，不可全部为0或者全部为1。全部为0只有在表示对应的网络地址或者IP地址不可获知的情况下才使用，而全部为1的主机地址通常作为广播地址。
  
  广播地址用于正在同一链路中相互连接的主机之间发送数据，IP地址中的主机标示全部设置为1，就成为了广播地址，如172.20.255.255。
  
  广播分为两种：
  
  - 本地广播
  	在本网络内的广播叫做本地广播，例如网络地址为192.168.0.0/24的情况下，广播地址是192.168.0.255。因为这个广播地址会被路由器屏蔽，所以不会到达192.168.0.0/24以外的其他链路上。
  - 直接广播
  	在不同网络之间的广播叫直接广播，例如192.168.0.0/24向192.168.1.255/24的目标地址发送IP包。收到这个包的路由器将数据转发给192.168.1.0/24，从而使192.168.1.0 ~ 192.168.1.254的主机都能收到这个包。
  
  直接广播可以穿透路由器，本地广播不可以。
  
  多播用于将包发送给特定组内的所有主机。由于其直接使用IP协议，因此也不存在可靠传输。只给那些必要的组发送数据包。 从224.0.0.0到239.255.255.255都是多播地址的可用范围。其中从224.0.0.0到224.0.0.255的范围不需要路由控制，在同一个链路内也能实现多播。而在这个范围之外设置多播地址会给全网所有组内成员发送多播的包。
  
  此外，对于多播，子网内所有的主机必须属于224.0.0.1的组，子网内所有的路由器必须属于224.0.0.2的组。（多播还有其他地址。）
  
  关于单播、广播和多播的区别请点[这里](http://blog.csdn.net/wangerge/article/details/3931491)。
  
  > 到现在已经比较困惑广播到底可不可以穿透路由器了。《图解TCP/IP》里面看样子是可以的，可是搜到的各种资料里面，大致意思都是不可以。
  
###子网掩码

一个IP地址只要确定了其分类，就确定了他的网络标示和主机标示。这样划分网络的粒度比较大，例如一个B类IP网络理论上一个链路允许65353个主机，然而实际情况中用不完这么多，这样就造成了浪费。

现在一个IP地址的网络标示和主机标示已不再受限于该地址的类别了，而是通过“子网掩码”划分出比A,B,C,D类粒度更细小的网络。 引入子网掩码之后，IP地址就有两个识别码了，一个是IP地址本身，另一个是表示网络标示的子网掩码。子网掩码也是32位的二进制。

两种缓解IP地址不够用的方法：
	
- CIDR（无类型域间选路）：采用任意长度分割IP地址的网络标示和主机标示。

	根据CIDR，连续多个C类地址就可以划分到一个较大的网络内。CIDR更有效地利用了当前IPv4地址，同时通过路由集中降低了路由器的负担。在CIDR被应用到互联网的初期，网络内部采用固定长度的子网掩码机制，也就是说域内所有子网掩码都得使用相同的长度。
- VLSM（可变长子网掩码variable length subnet mark），可以随机修改组织内各个部门的子网掩码长度的机制。

	根据VLSM可以讲网络地址划分为主机数为500个时，子网掩码长度为23，主机数为50个时，子网掩码长度为26。
- 全局地址和私有地址

	不要求为每一台主机或路由器分配一个固定的IP地址，而是在必要的时候，只为相应数量的设备分配唯一的IP地址。尤其对于那些没有连接互联网的独立网络中的主机，只要保证在这个网络内地址唯一，可以不考虑互联网即配置相应的IP地址。私有IP最早没有计划连接互联网，然而当一种能够互换私有IP和全局IP的NAT技术诞生之后，私有IP的主机与配有全局地址的互联网主机实现了通信。
	
路由控制表中记录着网络地址与下一步应该发送至路由器的地址。在发送IP包时，首先要确定IP包首部中的目标地址，再从路由控制表中找到与该地址具有相同网路地址的记录，如果存在多条吻合的，则采用最长匹配的那个。

- 默认路由
	
	默认路由（Default route），是对IP数据包中的目的地址找不到存在的其他路由时，路由器所选择的路由。目的地不在路由器的路由表里的所有数据包都会使用默认路由。主机里的默认路由通常被称作默认网关。默认网关通常会是一个有过滤功能的设备，如防火墙和代理服务器。IPv4默认路由是0.0.0.0/0
	
- 主记路由

	IP地址/32被称为主机路由，它的意思是整个IP地址的所有位都将参与路由。主机路由多被用于不希望通过网络地址路由的情况。
	
	路由控制表的聚合，主要体现在路由控制表可以自动升级，以及对外呈现时自动升级。
	![image](http://francisnote.qiniudn.com/tcp_ip_2.png)
	
###IP分割处理与再构成处理

每种数据链路的最大传输单元（MTU）都不尽相同，所以最早在传输IP包的时候，如果超过了MTU，则路由器会对IP包进行分割，然后由目标主机进行拼装。

随着互联网的发展，路由器的负荷不断加重，只要允许是不希望路由器进行IP数据包的分片处理的。因此产生了新的技术“路径MTU发现”。所谓路径MTU是指发送端主机到接收端主机之间不需要分片时最大MTU的大小，即路径中存在的所有数据链路中最小的MTU。

工作原理大致是这样的：

1. 发送时IP首部的分片标志设置为不分片；
2. 任何MTU小于包大小的都会抛弃当前包，并发回ICMP通知，包含MTU大小；
3. 主机减少包大小，直到没有ICMP通知。

这是UDP的情况，在TCP的情况下，根据路径MTU的大小计算出最大段长度（MSS）,然后再根据这些信息进行数据报的发送，IP层不会再进行分片处理。

###IPv6

128位，地址结构如下：

![image](http://francisnote.qiniudn.com/tcp_ip_3.png)

IPv4和IPv6的首部格式就算了，肯定记不住。

----

##IP协议相关技术

###DNS(Domain Name System)

DNS服务器用于将域名翻译为对应的IP地址，DNS服务器的分布呈树形结构，有层级关系，根节点为根域名服务器，每个服务器管理不同的域。

当进行DNS解析的时候，如果当前域名服务器无法解析，则将其上一层域名服务器，直至根域名服务器，根域名服务器会将需要解析的域名交给相应的域名服务器处理。

###ARP(Address Resolution Protocol)

ARP是一种解决地址问题的协议。通过IP地址，来定位下一个应该接收数据分包的网络设备对应的MAC地址。反之通过MAC地址定位IP地址的是RARP协议（Reverse Address Resolution Protocol）。

ARP借助于ARP请求和ARP响应两种类型的包确定MAC地址，起初要通过广播发送一个ARP请求包，该包会被同一链路上所有主机和路由器解析。

通常ARP包会被路由器隔离，但是采用代理ARP的路由器可以将ARP包转发给邻近的网段。

> 这里有个问题，假设IP地址足够用且不重复，是否可以只要IP地址，不要MAC地址？[知乎的一个讨论](http://www.zhihu.com/question/21546408)

####ICMP

ICMP主要功能：确认IP包是否成功送达目标地址，通知在发送过程中IP包被废弃的具体原因，改善网络设置等。（ICMP只负责IP相关的设置，大致的作用就是在IP发送过程中出现问题之后给予响应。）

ICMP的消息大致可以分为两类：一类是通知出错原因的错误消息，另一类是用于诊断的查询消息。主要消息有：

- 目标不可达消息
- 重定向消息（路由器发现发送端主机使用了次优的路径发送数据）
- 超市消息（IP包中有一个字段叫TTL，它的值随着没经过一次路由器就会减1，直到减到0时该IP包被丢弃。）
- 回送消息
- 原点抑制消息
- 路由探索消息
- 地址掩码消息

IPv6中ICMP的作用被扩大，尤其在IPv6中，从IP地址定位MAC地址的协议从ARP转为ICMP的邻居探索消息。这种邻居探索消息融合了IPv4的ARP、ICMP重定向以及ICMP路由器选择消息等功能于一体，甚至还提供了自动设置IP地址的功能。

IPv6中将ICMP的消息大致分为两类：一类是错误消息，一类是信息消息。

邻居请求消息用于查询IPv6的地址与MAC地址的对应关系，并由邻居宣告消息得知MAC地址。邻居请求消息利用IPv6的多播地址实现传输。（跟ARP差不多）

###DHCP

为了实现自动设置IP地址、统一管理IP地址分配，就产生了DHCP（Dynamic Host Configuration Protocol）协议。也就是说，DHCP让即插即用变得可能。

在使用DHCP之前，需要架设一台DHCP服务器，然后将DHCP所要分配的IP地址设置到服务器上，此外还有子网掩码、路由控制信息以及DNS服务器的地址等信息。获取IP地址流程如下：
![image](http://francisnote.qiniudn.com/tcp_ip_4.png)

对于大型网络，当有多个网段的时候，即使路由器能分担DHCP的功能，为多个路由器设置各自IP范围也着实麻烦。这个时候每个网段设置一个DHCP中继代理即可，DHCP服务器上面配置每个网段的信息。主机向DHCP中继代理发送DHCP请求包，之后中继代理以单播的形式发给DHCP服务器。

###NAT

NAT（Network Address Translator）是用于在本地网络中使用私有地址，在连接互联网的时候转而使用全局IP的技术。此外还有NAPT(Network Address Ports Translator)，由此可以实现用一个全局IP地址与多个主机通信（主要是将不同主机对应到全局IP的不同端口）。

在NAT路由器的内部，有一张自动生成的用来转换地址的表。在TCP/UDP通信中，只有当目标地址、源地址、目标端口、源端口和协议类型五项内容都一致时才认为是同一个通信连接。

NAT-PT：将IPv6的首部转化为IPv4的首部的一种技术。

NAT问题：

- 无法从NAT的外部向内部服务器建立连接
- 转换表的生成与转换操作都会产生一定开销
- 通信过程中一旦NAT遇到异常需要重启，所有的TCP连接都将被重置。
- 即使备置两台NAT做容灾，TCP连接还是会被断开

解决办法：

- IPv6，这样所有的设备都可以有一个全局IP
- NAT穿越（这个没看懂）

IP隧道
IP多播相关技术
IP任播
通信质量控制
显示拥塞通知
Mobile IP

----

##TCP与UDP

在TCP/IP中能够实现传输功能的、具有代表性的协议是TCP和UDP。

- TCP

	TCP是面向连接的、可靠的流协议。流就是指不间断的数据结构，你可以把它想象成排水管道中的水流。当应用程序采用TCP发送消息时，虽然可以保证发送顺序，但还是犹如没有任何间隔的数据流发送给接收端。TCP提供可靠性传输，实行“顺序控制”或“重发控制”机制。此外还具备“流量控制”、“拥塞控制”、提高网络利用率等众多功能。
	
	TCP主要用于为应用提供可靠传输。
	
- UDP

	UDP是不具有可靠性的数据报协议。细微的处理它会交给上层应用完成；在UDP的情况下，虽然可以确保发送消息的大小，却不能确保消息一定会到达。
	
	UDP主要用于那些对高速传输和实时性有较高要求的通信或广播通信。

数据链路和IP中的地址，分别指的是MAC地址和IP地址，在传输层中也有这样类似于地址的概念，那就是端口号，因此端口号也被称为程序地址。

UDP面向无连接，可随时发送数据，对数据传输不做保证，因此经常用于以下几个方面：

- 包总量较少的通信（DNS， SNMP）
- 视频音频等多媒体通信（即时通信）
- 限定于LAN等特定网络中的应用通信
- 广播通信（广播、多播）

TCP通过检验和、序列号、确认应答、重发控制、连接管理以及窗口控制等机制实现可靠性传输。

在TCP中，当发送端的数据到达接收主机时，接收端主机会返回一个已收到消息的通知。这个消息叫做确认应答。TCP通过肯定的确认应答（ACK）实现可靠的数据传输，如果没有收到确认应答，要么是目标主机没有接收到消息，要么是目标主机的确认应答在途中丢失。

序列号是按顺序给发送数据的每一个字节（8位字节）都标上号码的编号。接收端查询接收数据TCP首部中的序列号和数据的长度，将自己下一步应该接收的序列号作为确认应答送回去。

确认重发超时时间，理想情况下是找到一个最小时间，它能保证“确认应答一定能在这个时间内返回”。实际上TCP在每次发包时都会计算往返时间及其偏差。超时时间就是比将这个往返时间和偏差相加得到的结果稍大一点的值。（书上这么描述的，感觉略模糊。）之所以这么做是考虑到网络环境的不同导致的传输时间的波动。

TCP面向连接，连接的建立和断开分别需要三次握手和四次分手。TCP以段为单位发送数据，理想情况下最大消息长度（MSS）正好是IP中不会被分片处理的最大数据长度。（MSS是可以发送的数据包得长度，一个段相当于MSS+TCP首部，每一个窗口相当于一个段。）

TCP利用窗口机制提高发送效率，使用了窗口控制之后，某些确认应答及时丢失也无需重发。（可以通过下一个确认应答进行确认，后面的数据收到了，那么前面的肯定也收到了。）当某一段报文丢失之后，同一序号的确认应答将会被重复不断地返回，如果发送端主机连续三次收到了同一确认应答，那么就将其对应的数据重发，这种机制比之前的超时重发更高效，因此也被称为高速重发机制。

流控制（流量控制），接收端会将接收到的数据缓存下来，然后处理，处理数据也需要一定时间，所以接收端会在确认应答里面将自己缓冲区大小告诉发送端。发送端下次发送报文时，会根据此字段调整窗口大小。此字段值越大，表明网络的吞吐量越高。当接收端缓冲区已满，暂停接收数据之后（这时发送端窗口大小为0），发送端是不是的会发送一个叫窗口探测的数据段，此数据段仅包含一个字节以获取最新的窗口大小信息。

拥塞控制，在通信刚开始的时候通过“慢启动算法”对发送数据量进行控制：最开始将发送窗口大小设置为1，之后每收到一次确认应答（ACK），拥塞重口大小就加1。随着拥塞重口以1，2，4等指数函数的增长，拥堵状况激增，甚至导致网络拥塞。为了防止这些，引入了慢启动阀值得概念，当拥塞窗口大小超过慢启动阀值时，在每收到一次确认应答，只允许以下面的这种比例放大拥塞窗口：（1个数据段的字节数 * 1个数据段的字节数）/ 拥塞窗口字节数。TCP通信开始时，并没有设置相应的慢启动阀值，而是在超时重发时，才会设置为当时拥塞窗口的一半。进行高速重发控制时，慢启动阀值被设置为当时窗口大小的一半，然后将窗口大小设置为该慢启动阀值+3个数据段的大小。

其他提高网络利用率的规范

- Nagle算法
	
	Nagle算法只在满足下列任一条件时才会发送数据：1）已发送的数据都咦收到确认应答，2）可发送最大段长度（MSS）的数据时
	
- 延迟确认应答
	
	收到数据以后并不立即返回确认应答，而是延迟一段时间：1）在没有收到2x最大段长度的数据为止不做确认应答；2）其他情况最多延迟0.5秒发送确认应答。
	
- 捎带应答

	TCP的确认应答和回执数据（对发送数据的处理结果）可以通过一个包发送。

----

##路由协议

路由控制分静态（手动设置）和动态两种，动态路由是指相邻路由器会相互发送自己已知的网络连接信息，这些信息又可以传递给其他路由器。

根据路由控制的范围常使用IGP(Interior Gateway Protocol)和EGP(Exterior Gateway Protocol)两种类型的路由协议。自治系统（比如公司自己的内部网络）内部动态路由采用的是域内路由协议IGP，自治系统之间的路由控制采用的是域间路由协议EGP。（EGP就像是IP地址的网络部分，IGP就像是IP地址的主机部分。）

路由控制主要算法：距离向量算法和链路状态算法。

- 距离向量算法

	距离向量算法是根据距离（代价）和方向决定目标网络或主机位置的一种方法。这种方法在处理上很简单，只有距离和方向，所以网络复杂的时候，在获得稳定的路由信息之前需要消耗一定时间，也极易发生路由循环等问题。（还有一个缺点是不太容易判断每个路由器上的信息是否正确）

- 链路状态算法

	链路状态算法是路由器在了解网络整体状态的基础上生成路由控制表的一种方法。主要问题在于网络规模巨大而复杂的时候管理和处理信息需要告诉CPU和大量内存。

路由协议：

- RIP(Routing Information Protocol)，距离向量型，广泛用于LAN。

	RIP中距离的单位是跳数，即所经过的路由器数。如果有两条路径，则会选择距离较短的那个。
	
	RIP每30秒会向全网广播路由信息，采用RIP进行路由控制的范围内必须注意两点：1）因IP地址的分类而产生不同的网络地址时；2）构造网络地址长度不同的网络环境时。
	
	RIP的行为可以归纳为两点：1）将自己所知道的路由信息定期进行广播；2）一旦认为网络被断开，数据将无法流过此路由器，其他路由器也就可以得知网络已断开。为解决无限计数问题（收到自己发出去的消息）采取以下两种办法：1）最大长度不超过16；2）路由器不在把收到的路由信息原路返还给发送端。
	
	为了解决环路的问题，提出了“毒性逆转”和“触发更新”两种方法，毒性逆转：当网络发生链路断开的时候，不是不再发送消息，而是将这个无法通信的消息传播出去。触发更新是指当路由信息发生变化时，不等待30秒，而是立即发送出去的一种办法。

- RIP2

	相比于RIP的几点更新：
	
	- 使用多播 
	- 支持子网掩码
	- 路由选择域
	- 外部路由标志
	- 身份验证密钥

- OSPF
- BGP
- MPLS(最后这三个没好好看)

----
